# Crivus QuizIQ

WebApp privado de métricas de quiz com sistema de tracking via snippet para WordPress Elementor e HTML.

## Características

- **Autenticação própria**: argon2id + JWT com proteção CSRF e lockout
- **Dois tipos de usuários**:
  - `friend`: cria e gerencia trackers próprios
  - `super_admin`: administração global (políticas, usuários, moderação)
- **Snippet de tracking**: HTML/WordPress Elementor compatível
- **Coleta de eventos**: endpoint `/api/collect` com rate-limiting e validação de origins
- **Métricas**: overview, top pages, drop-off, UTM stats
- **Exportação**: PDF (com gráficos) e TXT (tabelas ASCII)
- **i18n**: Suporte para EN, FR, PT, ES
- **Mobile/Tablet-first**: Design responsivo otimizado para 360-1024px

## Stack Tecnológica

- **Frontend**: Next.js 14 (App Router) + TypeScript + TailwindCSS
- **Backend**: Next.js API Routes + Drizzle ORM + PostgreSQL (Supabase)
- **Autenticação**: argon2 (argon2id) + jose (JWT HS256)
- **Validação**: Zod
- **Gráficos**: Recharts
- **Animações**: Framer Motion
- **Export PDF**: Puppeteer
- **i18n**: next-intl

## Setup

### 1. Instalar Dependências

```bash
npm install
```

### 2. Configurar Variáveis de Ambiente

Crie um arquivo `.env` na raiz do projeto:

```env
# Database
DATABASE_URL=postgresql://USER:PASSWORD@HOST:PORT/DB?sslmode=require

# JWT
JWT_SECRET=your-secret-key-change-this-to-a-strong-uuid

# Invite
INVITE_SECRET=your-invite-secret-change-this-to-a-strong-uuid

# App
APP_URL=https://your-domain.com
NEXT_PUBLIC_APP_URL=http://localhost:3000
```

**Importante**: Gere UUIDs seguros para `JWT_SECRET` e `INVITE_SECRET`:
```bash
# Linux/Mac
uuidgen

# Ou use um gerador online
```

### 3. Configurar Banco de Dados

#### 3.1. Criar Schema no Supabase

Acesse o Supabase Dashboard e execute o SQL no editor SQL:

```sql
-- Criar enums
CREATE TYPE role AS ENUM ('super_admin', 'friend');
CREATE TYPE member_role AS ENUM ('viewer');

-- Users
CREATE TABLE IF NOT EXISTS users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  email TEXT UNIQUE NOT NULL,
  pass_hash TEXT NOT NULL,
  role role NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  last_login_at TIMESTAMPTZ
);

-- Invites
CREATE TABLE IF NOT EXISTS invites (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  code TEXT UNIQUE NOT NULL,
  email TEXT NOT NULL,
  role role NOT NULL,
  expires_at TIMESTAMPTZ NOT NULL,
  consumed_at TIMESTAMPTZ,
  one_time BOOLEAN NOT NULL DEFAULT TRUE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Trackers
CREATE TABLE IF NOT EXISTS trackers (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tracker_id TEXT UNIQUE NOT NULL,
  owner_user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  site_url TEXT NOT NULL,
  origins TEXT[] NOT NULL DEFAULT '{}',
  active BOOLEAN NOT NULL DEFAULT TRUE,
  page_rules JSONB,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  revoked_at TIMESTAMPTZ
);

-- Tracker Members
CREATE TABLE IF NOT EXISTS tracker_members (
  tracker_id TEXT NOT NULL REFERENCES trackers(tracker_id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  role member_role NOT NULL DEFAULT 'viewer',
  PRIMARY KEY (tracker_id, user_id)
);

-- Events
CREATE TABLE IF NOT EXISTS events (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  ts BIGINT NOT NULL,
  ev TEXT NOT NULL,
  sid TEXT NOT NULL,
  tracker_id TEXT NOT NULL REFERENCES trackers(tracker_id) ON DELETE CASCADE,
  page_url TEXT NOT NULL,
  path TEXT NOT NULL,
  ref TEXT,
  utm_source TEXT,
  utm_medium TEXT,
  utm_campaign TEXT,
  utm_term TEXT,
  utm_content TEXT,
  sw INT,
  sh INT,
  quiz_id TEXT,
  question_id TEXT,
  answer_id TEXT,
  extra JSONB,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_events_tracker_ts ON events(tracker_id, ts);
CREATE INDEX IF NOT EXISTS idx_events_tracker_path ON events(tracker_id, path);

-- Leads
CREATE TABLE IF NOT EXISTS leads (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  ts BIGINT NOT NULL,
  tracker_id TEXT NOT NULL REFERENCES trackers(tracker_id) ON DELETE CASCADE,
  sid TEXT NOT NULL,
  email TEXT,
  name TEXT,
  phone TEXT,
  extra JSONB,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_leads_tracker_ts ON leads(tracker_id, ts);

-- Policies
CREATE TABLE IF NOT EXISTS policies (
  id BOOLEAN PRIMARY KEY DEFAULT TRUE,
  max_trackers_per_user INT NOT NULL DEFAULT 10,
  max_collect_rps_per_origin INT NOT NULL DEFAULT 10,
  retention_days INT NOT NULL DEFAULT 365,
  allowed_origins TEXT[] NOT NULL DEFAULT '{}'
);

-- Auth Attempts
CREATE TABLE IF NOT EXISTS auth_attempts (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  email TEXT,
  ip INET,
  success BOOLEAN NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

#### 3.2. Gerar Migrações com Drizzle (Opcional)

```bash
npm run db:generate
npm run db:migrate
```

### 4. Criar Primeiro Super Admin

Crie um script `scripts/create-super-admin.ts`:

```typescript
import { db } from "../src/server/db";
import { users } from "../src/server/db/schema";
import { hashPassword } from "../src/server/auth";

async function createSuperAdmin() {
  const email = process.argv[2];
  const password = process.argv[3];

  if (!email || !password) {
    console.error("Usage: tsx scripts/create-super-admin.ts <email> <password>");
    process.exit(1);
  }

  const passHash = await hashPassword(password);
  
  await db.insert(users).values({
    email,
    passHash,
    role: "super_admin",
  });

  console.log(`Super admin created: ${email}`);
}

createSuperAdmin();
```

Execute:

```bash
npx tsx scripts/create-super-admin.ts admin@example.com your-password
```

### 5. Executar Aplicação

```bash
npm run dev
```

Acesse: http://localhost:3000

## Uso

### 1. Login

- Faça login com o super admin criado
- Ou crie um convite para um `friend` via `/admin` (rota `/api/auth/invite`)

### 2. Criar Tracker (Friend)

1. Acesse `/my/trackers`
2. Clique em "Create Tracker"
3. Preencha nome e URL do site
4. O sistema gera automaticamente um `tracker_id` (ex: `trk_ab12cd34`)
5. Copie o snippet gerado

### 3. Instalar Snippet

#### WordPress Elementor Pro

1. Vá em **Elementor Pro → Custom Code → Body End**
2. Cole o snippet completo
3. Salve

#### HTML

1. Abra o arquivo HTML do seu site
2. Cole o snippet antes do `</body>`
3. Salve

### 4. Usar API no Frontend

O snippet expõe `window.qz` com métodos:

```javascript
// Iniciar quiz
window.qz.start('quiz-123');

// Visualizar pergunta
window.qz.qView('quiz-123', 'question-1');

// Selecionar resposta
window.qz.aPick('quiz-123', 'question-1', 'answer-a');

// Submeter pergunta
window.qz.qSubmit('quiz-123', 'question-1', true);

// Completar quiz
window.qz.done('quiz-123', 85);

// Capturar lead
window.qz.lead('quiz-123', {
  email: 'user@example.com',
  name: 'John Doe',
  phone: '+1234567890'
});

// CTA click (via atributos HTML)
// <button data-qz-cta="Download" data-qz-id="quiz-123">Download</button>
window.qz.cta('quiz-123', 'Download');
```

### 5. Visualizar Métricas

1. Acesse `/dashboard`
2. Selecione um tracker
3. Visualize:
   - **Overview**: KPIs + gráfico de série temporal
   - **Top Pages**: Páginas mais visitadas
   - **Drop-off**: Taxa de abandono por quiz
   - **UTM Stats**: Performance por campanha
   - **Leads**: Lista de leads capturados

### 6. Exportar Relatórios

1. No dashboard, clique em "Export Report"
2. Selecione:
   - **Formato**: PDF ou TXT
   - **Período**: Data inicial e final
   - **Granularidade**: Dia, Mês ou Ano
   - **Seções**: Overview, Top Pages, UTM, Leads
3. Clique em "Export"

## Endpoints API

### Autenticação

- `POST /api/auth/login` - Login
- `POST /api/auth/logout` - Logout
- `GET /api/auth/me` - Perfil do usuário
- `POST /api/auth/invite` - Criar convite (super_admin)
- `POST /api/auth/accept-invite` - Aceitar convite
- `POST /api/auth/change-password` - Alterar senha

### Trackers

- `GET /api/trackers` - Listar trackers do usuário
- `POST /api/trackers` - Criar tracker
- `GET /api/trackers/[id]` - Detalhes do tracker
- `PATCH /api/trackers/[id]` - Atualizar tracker
- `DELETE /api/trackers/[id]` - Deletar tracker

### Coleta

- `POST /api/collect` - Coletar evento (público, usado pelo snippet)

### Estatísticas

- `GET /api/stats/overview?tracker_id&from&to&groupBy` - Overview
- `GET /api/stats/top-pages?tracker_id&from&to` - Top Pages
- `GET /api/stats/dropoff?tracker_id&quiz_id&from&to&groupBy` - Drop-off
- `GET /api/stats/utm?tracker_id&from&to` - UTM Stats

### Leads

- `GET /api/leads/list?tracker_id&from&to&page&limit&search` - Listar leads
- `GET /api/leads/export?tracker_id&from&to` - Exportar CSV

### Exportação

- `POST /api/export/pdf` - Gerar PDF
- `POST /api/export/txt` - Gerar TXT

## Segurança

- **Autenticação**: JWT em cookie httpOnly + SameSite=Lax
- **Lockout**: 5 tentativas falhas em 15min → bloqueio por 15min
- **CSRF**: Token X-CSRF emitido no login
- **Rate Limiting**: `/api/collect` e `/api/auth/login`
- **Validação de Origins**: CORS restrito aos origins do tracker + políticas globais
- **Sanitização**: Truncamento de URLs (1024 chars) e validação de inputs

## Estrutura do Projeto

```
src/
  app/
    login/page.tsx
    dashboard/page.tsx
    my/trackers/
      page.tsx
      [id]/page.tsx
    admin/
      page.tsx
      users/
      policies/
      audit/
      moderation/
    api/
      auth/
      trackers/
      collect/
      stats/
      leads/
      export/
  server/
    db/
      schema.ts
      index.ts
    auth.ts
    policies.ts
    trackers.ts
    rateLimit.ts
    stats.ts
    exportPdf.ts
    exportTxt.ts
  components/
    ui/
  lib/
    utils.ts
  i18n/
messages/
  pt.json
  en.json
  fr.json
  es.json
```

## Desenvolvimento

```bash
# Desenvolvimento
npm run dev

# Build
npm run build

# Iniciar produção
npm start

# Lint
npm run lint

# Drizzle
npm run db:generate
npm run db:migrate
npm run db:studio
```

## Licença

Privado - Todos os direitos reservados.

